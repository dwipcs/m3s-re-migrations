START TRANSACTION;

CREATE TABLE IF NOT EXISTS `aids` (
    `id`                INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    `principle_id`      INT UNSIGNED NOT NULL,
    `name`              VARCHAR(255) NOT NULL,
    `value`             VARCHAR(255) NOT NULL,
    `tlv`               TEXT NOT NULL,
    `is_active`         BOOLEAN NOT NULL DEFAULT TRUE,
    `created_at`        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted_at`        TIMESTAMP NULL DEFAULT NULL,
    `tlv_hash_active`   BINARY(32) GENERATED ALWAYS AS (IF(`deleted_at` IS NULL, UNHEX(SHA2(`tlv`, 256)), NULL)) STORED,
    INDEX `idx_principle_id` (`principle_id`),
    CONSTRAINT `fk_aids_principle_id_principles` FOREIGN KEY (`principle_id`) REFERENCES `principles`(`id`) ON DELETE RESTRICT,
    UNIQUE KEY `uq_aids_principle_tlv_hash_active` (`principle_id`, `tlv_hash_active`)
);

CREATE TABLE IF NOT EXISTS `aid_configs` (
    `id`                INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    `aid_id`            INT UNSIGNED NOT NULL,
    `name`              VARCHAR(255) NOT NULL,
    `tag`               VARCHAR(255) NOT NULL,
    `value`             VARCHAR(255) NOT NULL,
    `created_at`        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`        TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted_at`        TIMESTAMP NULL DEFAULT NULL,
    `tag_active`        VARCHAR(255) GENERATED ALWAYS AS (IF(`deleted_at` IS NULL, `tag`, NULL)) STORED,
    `value_active`      VARCHAR(255) GENERATED ALWAYS AS (IF(`deleted_at` IS NULL, `value`, NULL)) STORED,
    INDEX `idx_aid_id` (`aid_id`),
    CONSTRAINT `fk_aid_configs_aid_id_aids` FOREIGN KEY (`aid_id`) REFERENCES `aids`(`id`) ON DELETE RESTRICT,
    UNIQUE KEY `uq_aid_configs_aid_tag_active_value_active` (`aid_id`, `tag_active`, `value_active`)
);

CREATE TABLE IF NOT EXISTS `capks` (
    `id`                    INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    `principle_id`          INT UNSIGNED NOT NULL,
    `index`                 VARCHAR(50) NOT NULL COMMENT '9F22',
    `modulus`               MEDIUMTEXT NOT NULL COMMENT 'DF02',
    `exponent`              VARCHAR(50) NOT NULL COMMENT 'DF04',
    `expiration_date`       VARCHAR(50) NULL DEFAULT NULL COMMENT 'DF05',
    `checksum`              VARCHAR(255) NOT NULL COMMENT 'DF03',
    `algorithm_indicator`   VARCHAR(50) NOT NULL COMMENT 'DF07',
    `tlv`                   TEXT NOT NULL,
    `created_at`            TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`            TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted_at`            TIMESTAMP NULL DEFAULT NULL,
    `tlv_hash_active`       BINARY(32) GENERATED ALWAYS AS (IF(`deleted_at` IS NULL, UNHEX(SHA2(`tlv`, 256)), NULL)) STORED,
    INDEX `idx_principle_id` (`principle_id`),
    CONSTRAINT `fk_capks_principle_id_principles` FOREIGN KEY (`principle_id`) REFERENCES `principles`(`id`) ON DELETE RESTRICT,
    UNIQUE KEY `uq_capks_principle_tlv_hash_active` (`principle_id`, `tlv_hash_active`)
);

COMMIT;

START TRANSACTION;

INSERT INTO 
    `aids` (`principle_id`, `name`, `value`, `tlv`, `is_active`) 
VALUES
    (1, 'Visa Credit', 'A0000000031010', '612C4F07A0000000031010500B5669736120437265646974870101', TRUE),
    (1, 'Visa Debit', 'A0000000032010', '612B4F07A0000000032010500A56697361204465626974870102', TRUE),
    (2, 'Mastercard Credit', 'A0000000041010', '612F4F07A000000004101050104D61737465726361726420437265646974870101', TRUE),
    (2, 'Mastercard Debit', 'A0000000043060', '612E4F07A0000000043060500F4D617374657263617264204465626974870102', TRUE),
    (1, 'JCB', 'A0000000651010', '61284F07A000000065101050034A4342870101', TRUE);

INSERT INTO 
    `aid_configs` (`aid_id`, `name`, `tag`, `value`) 
VALUES
    (1, 'Terminal Country Code', '9F1A', '0360'),
    (1, 'Transaction Currency Code', '5F2A', '0360'),
    (1, 'Terminal Capabilities', '9F33', 'E0F8C8'),
    (1, 'Terminal Type', '9F35', '22'),
    (3, 'Terminal Country Code', '9F1A', '0360'),
    (3, 'Transaction Currency Code', '5F2A', '0360'),
    (3, 'Terminal Capabilities', '9F33', 'E0F0C8'),
    (3, 'Terminal Type', '9F35', '22'),
    (3, 'Card Data Input Capability', '9F6D', '60'),
    (5, 'Terminal Country Code', '9F1A', '0360'),
    (5, 'Transaction Currency Code', '5F2A', '0360'),
    (5, 'Terminal Capabilities', '9F33', 'E0E0C8');

INSERT INTO 
    `capks` (`principle_id`, `index`, `modulus`, `exponent`, `expiration_date`, `checksum`, `algorithm_indicator`, `tlv`) 
VALUES
(
    1,
    '08', 
    'D9FD6ED75D51D0E30664BD157023EAA1FFA871E4DA65672B863D255E81E137A51DE4F72BCC9E44ACE12127F87E263D3AF9DD9CF35CA4A7B01E907000BA85D24954C2FCA3074825DDD4C0C8F186CB020F683E02F2DEAD3969133F06F7845166ACEB57CA0FC2603445469811D293BFEFBAFAB57631B3DD91E796BF850A25012F1AE38F05AA5C4D6D03B1DC2E568612785938BBC9B3CD3A910C1DA55A5A9218ACE0F7A21287752682F15832A678D6E1ED0B', 
    '03', 
    '20241231',
    '20D213126955DE205ADC2FD2822BD22DE21CF9A8',
    '01',
    '9F0605A000000003DF040103DF050420241231DF0701019F220108DF031420D213126955DE205ADC2FD2822BD22DE21CF9A8DF0281B0D9FD6ED75D51D0E30664BD157023EAA1FFA871E4DA65672B863D255E81E137A51DE4F72BCC9E44ACE12127F87E263D3AF9DD9CF35CA4A7B01E907000BA85D24954C2FCA3074825DDD4C0C8F186CB020F683E02F2DEAD3969133F06F7845166ACEB57CA0FC2603445469811D293BFEFBAFAB57631B3DD91E796BF850A25012F1AE38F05AA5C4D6D03B1DC2E568612785938BBC9B3CD3A910C1DA55A5A9218ACE0F7A21287752682F15832A678D6E1ED0B'
),
(
    1,
    '09', 
    '9D912248DE0A4E39C1A7DDE3F6D2588992C1A4095AFBD1824D1BA74847F2BC4926D2EFD904B4B54954CD189A54C5D1179654F8F9B0D2AB5F0357EB642FEDA95D3912C6576945FAB897E7062CAA44A4AA06B8FE6E3DBA18AF6AE3738E30429EE9BE03427C9D64F695FA8CAB4BFE376853EA34AD1D76BFCAD15908C077FFE6DC5521ECEF5D278A96E26F57359FFAEDA19434B937F1AD999DC5C41EB11935B44C18100E857F431A4A5A6BB65114F174C2D7B59FDF237D6BB1DD0916E644D709DED56481477C75D95CDD68254615F7740EC07F330AC5D67BCD75BF23D28A140826C026DBDE971A37CD3EF9B8DF644AC385010501EFC6509D7A41', 
    '03', 
    '20281231',
    '1FF80A40173F52D7D27E0F26A146A1C8CCB29046',
    '01',
    '9F0605A000000003DF040103DF050420281231DF0701019F220109DF03141FF80A40173F52D7D27E0F26A146A1C8CCB29046DF0281F89D912248DE0A4E39C1A7DDE3F6D2588992C1A4095AFBD1824D1BA74847F2BC4926D2EFD904B4B54954CD189A54C5D1179654F8F9B0D2AB5F0357EB642FEDA95D3912C6576945FAB897E7062CAA44A4AA06B8FE6E3DBA18AF6AE3738E30429EE9BE03427C9D64F695FA8CAB4BFE376853EA34AD1D76BFCAD15908C077FFE6DC5521ECEF5D278A96E26F57359FFAEDA19434B937F1AD999DC5C41EB11935B44C18100E857F431A4A5A6BB65114F174C2D7B59FDF237D6BB1DD0916E644D709DED56481477C75D95CDD68254615F7740EC07F330AC5D67BCD75BF23D28A140826C026DBDE971A37CD3EF9B8DF644AC385010501EFC6509D7A41'
);

COMMIT;